<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Class Memories Chat</title>

<style>
body{
    margin:0;
    font-family:Arial, sans-serif;
    background:#ece5dd;
    height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
}

/* LOGIN SCREEN */
#loginScreen{
    background:white;
    padding:30px;
    border-radius:10px;
    box-shadow:0 5px 20px rgba(0,0,0,0.2);
    width:300px;
}

#loginScreen input{
    width:100%;
    padding:10px;
    margin:5px 0;
    border-radius:20px;
    border:1px solid gray;
}

#loginScreen button{
    width:100%;
    padding:10px;
    background:#25D366;
    border:none;
    border-radius:20px;
    color:white;
    cursor:pointer;
}

/* CHAT UI */
#chatUI{
    display:none;
    width:100%;
    height:100vh;
    flex-direction:column;
}

header{
    background:#075E54;
    color:white;
    padding:15px;
    display:flex;
    align-items:center;
    justify-content:space-between;
}

#onlineDot{
    width:10px;
    height:10px;
    background:lime;
    border-radius:50%;
    margin-right:5px;
}

#chatBox{
    flex:1;
    overflow-y:auto;
    padding:10px;
}

.msgRow{
    display:flex;
    margin:5px 0;
}

.profile{
    width:30px;
    height:30px;
    border-radius:50%;
    margin-right:5px;
}

.message{
    background:white;
    padding:10px;
    border-radius:10px;
    max-width:70%;
    position:relative;
    animation:fadeIn .3s ease;
}

.like{
    font-size:12px;
    cursor:pointer;
    color:red;
}

#inputArea{
    display:flex;
    padding:10px;
    background:white;
}

#inputArea input{
    flex:1;
    padding:10px;
    border-radius:20px;
    border:1px solid gray;
    margin-right:5px;
}

button{
    padding:10px;
    border:none;
    border-radius:20px;
    background:#25D366;
    color:white;
    cursor:pointer;
}

@keyframes fadeIn{
    from{opacity:0; transform:translateY(10px);}
    to{opacity:1; transform:translateY(0);}
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen">
<h3>Login üîê</h3>
<input type="text" id="name" placeholder="Your Name">
<input type="file" id="photo" accept="image/*">
<button onclick="login()">Enter Chat</button>
</div>

<!-- CHAT UI -->
<div id="chatUI">
<header>
<div style="display:flex;align-items:center;">
<div id="onlineDot"></div>
<span id="username"></span>
</div>
<div>
<button onclick="toggleMusic()">üé∂</button>
</div>
</header>

<div id="chatBox"></div>

<div id="inputArea">
<input type="text" id="message" placeholder="Type message üòäüî•‚ù§Ô∏è">
<button onclick="sendMessage()">Send</button>
</div>
</div>

<audio id="bgMusic" src="Venmathiye.mp3" loop></audio>
<audio id="notifySound" src="notify.mp3"></audio>

<script>
const url="https://script.google.com/macros/s/AKfycbwy5WoNGHuQiM9x23U9UMIAniTL1iWNtsqk9BqP__-24i2oUMg9TLFdTZ_Y4eNLwONy0Q/exec";

let currentUser="";
let currentPhoto="";
let lastMessageCount=0;
let musicPlaying=false;

function login(){
    currentUser=document.getElementById("name").value;
    currentPhoto=document.getElementById("photo").value;

    if(currentUser==""){
        alert("Enter name");
        return;
    }

    document.getElementById("loginScreen").style.display="none";
    document.getElementById("chatUI").style.display="flex";
    document.getElementById("username").innerText=currentUser;
}

function loadMessages(){
    fetch(url)
    .then(res=>res.json())
    .then(data=>{
        let chatBox=document.getElementById("chatBox");
        chatBox.innerHTML="";

        if(data.length > lastMessageCount){
            document.getElementById("notifySound").play();
        }
        lastMessageCount=data.length;

        data.forEach(msg=>{
            let row=document.createElement("div");
            row.className="msgRow";

            let img=document.createElement("img");
            img.src=msg.photo || "https://i.pravatar.cc/40";
            img.className="profile";

            let bubble=document.createElement("div");
            bubble.className="message";
            bubble.innerHTML=`
                <b>${msg.name}</b><br>
                ${msg.message}<br>
                <span class="like">‚ù§Ô∏è</span>
            `;

            bubble.ondblclick=function(){
                this.querySelector(".like").innerText="‚ù§Ô∏è Liked";
            }

            row.appendChild(img);
            row.appendChild(bubble);
            chatBox.appendChild(row);
        });

        chatBox.scrollTop=chatBox.scrollHeight;
    });
}

function sendMessage(){
  let message=document.getElementById("message").value;
  let file=document.getElementById("photo").files[0];

  if(file){
    let reader=new FileReader();
    reader.onload=function(){
      let base64=reader.result.split(",")[1];

      fetch(url,{
        method:"POST",
        body:JSON.stringify({
          type:"uploadImage",
          image:base64,
          mimeType:file.type,
          fileName:file.name
        })
      })
      .then(res=>res.json())
      .then(data=>{
        sendFinalMessage(data.url,message);
      });
    };
    reader.readAsDataURL(file);
  }else{
    sendFinalMessage("",message);
  }
}

function sendFinalMessage(photoUrl,message){
  fetch(url,{
    method:"POST",
    body:JSON.stringify({
      type:"message",
      name:currentUser,
      message:message,
      photo:photoUrl
    })
  }).then(()=>{
    document.getElementById("message").value="";
    document.getElementById("photo").value="";
    loadMessages();
  });
}

function toggleMusic(){
    let music=document.getElementById("bgMusic");
    if(!musicPlaying){
        music.volume=0.4;
        music.play();
        musicPlaying=true;
    }else{
        music.pause();
        musicPlaying=false;
    }
}

setInterval(loadMessages,3000);
</script>

</body>

</html>

